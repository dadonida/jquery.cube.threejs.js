/*
 * Copyright 2016 Jason Graves (GodLikeMouse/Collaboradev)
 * http://www.collaboradev.com
 *
 * This file is part of jquery.cube.threejs.js.
 *
 * The jquery.cube.threejs.js plugin is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation, either
 * version 3 of the License, or (at your option) any later version.
 *
 * The jquery.cube.threejs.js plugin is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with the jquery.cube.threejs.js plugin. If not, see http://www.gnu.org/licenses/.
 */

$.fn.cube=function(e){var t=this,a=null,c=null,o=null,r=[],n=null;function i(t,a,c){if(i[c])return i[c];var o=$("<canvas>").get(0);o.width=t,o.height=a;var r,n,p,y,s,l=o.getContext("2d");function u(e){var t=new THREE.Color(e),a=Number(255*t.r).toString(16),c=Number(255*t.g).toString(16),o=Number(255*t.b).toString(16);return"#"+(a=a.toString().length<2?"0"+a:a)+(c=c.toString().length<2?"0"+c:c)+(o=o.toString().length<2?"0"+o:o)}l.fillStyle=u(e.color[e.color.length-1]),l.fillRect(0,0,t,a),l.fillStyle=u(c),r=1,n=1,p=t-2,y=a-2,s=3,l.beginPath(),l.moveTo(r+s,n),l.lineTo(r+p-s,n),l.quadraticCurveTo(r+p,n,r+p,n+s),l.lineTo(r+p,n+y-s),l.quadraticCurveTo(r+p,n+y,r+p-s,n+y),l.lineTo(r+s,n+y),l.quadraticCurveTo(r,n+y,r,n+y-s),l.lineTo(r,n+s),l.quadraticCurveTo(r,n,r+s,n),l.closePath(),l.fill();var w=new Image;w.src=o.toDataURL();var h=new THREE.Texture(w);return h.anisotropy=4,h.needsUpdate=!0,i[c]=h,h}function p(t){for(var o=[],n=0;n<6;n++){var y=i(32,32,e.color[n]),s=new THREE.MeshBasicMaterial({map:y,overdraw:1});o.push(s)}var l=new THREE.MeshFaceMaterial(o),u="Canvas"==a.type?3:1;p.box||(p.box=new THREE.BoxGeometry(e.cubit.width,e.cubit.height,e.cubit.height,u,u,u));var w=new THREE.Mesh(p.box,l);return w.position.x=t.x,w.position.y=t.y,w.position.z=t.z,c.add(w),r.push(w),w.index=r.length-1,w}function y(){e.cubit={width:e.size.width/e.type,height:e.size.height/e.type};var t=0;e.type%2==0&&(t=e.cubit.width/2);for(var a=e.type-Math.ceil(e.type/2),o=new THREE.Vector3(0,0,0),r=0;r<e.type;r++){for(var i=0;i<e.type;i++)for(var y=0;y<e.type;y++){o.x=e.cubit.width*(y-a)+t,o.y=e.cubit.height*(i-a)+t,o.z=e.cubit.height*(r-a)+t;var s=p(o);y>0&&y<e.type-1&&i>0&&i<e.type-1&&r>0&&r<e.type-1&&(s.visible=!1)}n=new THREE.Object3D,c.add(n)}}function s(){requestAnimationFrame(s),a.render(c,o),o.lookAt(n.position)}function l(t,a){var c=e.type*e.type;switch(t){case"y":for(var o=[],n=a*e.type,i=0;i<e.type;i++){for(var p=0;p<e.type;p++){var y=p;o.push(r[n+y])}n+=c}return o;case"x":for(o=[],n=c+a,i=0;i<e.type;i++){for(p=0;p<e.type;p++){y=(p+1)*e.type;o.push(r[n-y])}n+=c}return o;case"z":for(o=[],n=c+a*c-e.type,i=0;i<e.type;i++){for(p=0;p<e.type;p++){y=p;o.push(r[n+y])}n-=e.type}return o}}function u(t,a){if("cw"==a){for(var c=[],o=e.type*(e.type-1),r=0;r<e.type;r++){for(var n=0;n<e.type;n++){var i=n*e.type;c.push(t[o-i].clone())}o++}return c}for(c=[],o=e.type-1,r=0;r<e.type;r++){for(n=0;n<e.type;n++){i=n*e.type;c.push(t[o+i].clone())}o--}return c}return e=$.extend(!0,{type:3,camera:{x:50,y:50,z:100},size:{width:60,height:60},color:[16711680,16744448,16776960,16777215,255,65280,0],background:1908512,animation:{delay:250},onTurn:$.noop,onComplete:$.noop},e),t.reset=function(){for(var e=c.children.length-1;e>=0;e--)c.remove(c.children[e]);r=[],y()},t.turn=function(a){e.onTurn(t,a);for(var o=null,r=Math.PI/180,i=null,p=0,y=n.children.length-1;y>=0;y--)c.add(n.children[y]),n.remove(n.children[y]);switch(n.children=[],a){case"U":(i=l(o="y",e.type-1)).to=u(i,"cw"),p=-90;break;case"U'":(i=l(o="y",e.type-1)).to=u(i,"ccw"),p=90;break;case"u":var s=l(o="y",e.type-2),w=l(o,e.type-1);(i=3==e.type?s.concat(w):s).to=u(s,"ccw"),e.type>=3&&(i.to=i.to.concat(u(w,"ccw"))),p=-90;break;case"u'":s=l(o="y",e.type-2),w=l(o,e.type-1);(i=3==e.type?s.concat(w):s).to=u(s,"cw"),e.type>=3&&(i.to=i.to.concat(u(w,"cw"))),p=90;break;case"R":(i=l(o="x",e.type-1)).to=u(i,"cw"),p=-90;break;case"R'":(i=l(o="x",e.type-1)).to=u(i,"ccw"),p=90;break;case"r":s=l(o="x",e.type-2),w=l(o,e.type-1);(i=3==e.type?s.concat(w):s).to=u(s,"cw"),3==e.type&&(i.to=i.to.concat(u(w,"cw"))),p=-90;break;case"r'":s=l(o="x",e.type-2),w=l(o,e.type-1);(i=3==e.type?s.concat(w):s).to=u(s,"ccw"),3==e.type&&(i.to=i.to.concat(u(w,"ccw"))),p=90;break;case"D":(i=l(o="y",0)).to=u(i,"ccw"),p=90;break;case"D'":(i=l(o="y",0)).to=u(i,"cw"),p=-90;break;case"d":o="y";s=l("y",0),w=l("y",1);(i=3==e.type?s.concat(w):s).to=u(s,"ccw"),3==e.type&&(i.to=i.to.concat(u(w,"ccw"))),p=90;break;case"d'":s=l(o="y",0),w=l(o,1);(i=3==e.type?s.concat(w):s).to=u(s,"cw"),3==e.type&&(i.to=i.to.concat(u(w,"cw"))),p=-90;break;case"L":(i=l(o="x",0)).to=u(i,"ccw"),p=90;break;case"L'":(i=l(o="x",0)).to=u(i,"cw"),p=-90;break;case"l":s=l(o="x",1),w=l(o,0);(i=3==e.type?s.concat(w):s).to=u(s,"cw"),3==e.type&&(i.to=i.to.concat(u(w,"cw"))),p=90;break;case"l'":s=l(o="x",1),w=l(o,0);(i=3==e.type?s.concat(w):s).to=u(s,"cw"),3==e.type&&(i.to=i.to.concat(u(w,"cw"))),p=-90;break;case"F":(i=l(o="z",e.type-1)).to=u(i,"cw"),p=-90;break;case"F'":(i=l(o="z",e.type-1)).to=u(i,"ccw"),p=90;break;case"f":s=l(o="z",e.type-2),w=l(o,e.type-1);(i=3==e.type?s.concat(w):s).to=u(s,"cw"),e.type>=3&&(i.to=i.to.concat(u(w,"cw"))),p=-90;break;case"f'":s=l(o="z",e.type-2),w=l(o,e.type-1);(i=3==e.type?s.concat(w):s).to=u(s,"ccw"),e.type>=3&&(i.to=i.to.concat(u(w,"ccw"))),p=90;break;case"B":(i=l(o="z",0)).to=u(i,"ccw"),p=90;break;case"B'":(i=l(o="z",0)).to=u(i,"cw"),p=-90;break;case"b":s=l(o="z",0),w=l(o,1);(i=3==e.type?s.concat(w):s).to=u(s,"ccw"),e.type>=3&&(i.to=i.to.concat(u(w,"ccw"))),p=90;break;case"b'":s=l(o="z",0),w=l(o,1);(i=3==e.type?s.concat(w):s).to=u(s,"cw"),e.type>=3&&(i.to=i.to.concat(u(w,"cw"))),p=-90;break;case"M":if(e.type%2!=0){o="x";var h=parseInt(e.type/2);(i=l(o,h)).to=u(i,"cw"),p=90}break;case"M'":if(e.type%2!=0){o="x";h=parseInt(e.type/2);(i=l(o,h)).to=u(i,"ccw"),p=-90}break;case"E":if(e.type%2!=0){o="y";h=parseInt(e.type/2);(i=l(o,h)).to=u(i,"cw"),p=-90}break;case"E'":if(e.type%2!=0){o="y";h=parseInt(e.type/2);(i=l(o,h)).to=u(i,"ccw"),p=90}break;case"S":if(e.type%2!=0){o="z";h=parseInt(e.type/2);(i=l(o,h)).to=u(i,"cw"),p=-90}break;case"S'":if(e.type%2!=0){o="z";h=parseInt(e.type/2);(i=l(o,h)).to=u(i,"ccw"),p=90}break;case"X":o="x";var f=[],v=(i=[],[]);for(y=e.type-1;y>=0;y--){var b=l(o,y);f.push(b),i=i.concat(b),v=v.concat(u(b,"cw"))}i.to=v,p=-90;break;case"X'":o="x";for(f=[],i=[],v=[],y=e.type-1;y>=0;y--){b=l(o,y);f.push(b),i=i.concat(b),v=v.concat(u(b,"ccw"))}i.to=v,p=90;break;case"Y":o="y";for(f=[],i=[],v=[],y=e.type-1;y>=0;y--){b=l(o,y);f.push(b),i=i.concat(b),v=v.concat(u(b,"cw"))}i.to=v,p=-90;break;case"Y'":o="y";for(f=[],i=[],v=[],y=e.type-1;y>=0;y--){b=l(o,y);f.push(b),i=i.concat(b),v=v.concat(u(b,"ccw"))}i.to=v,p=90;break;case"Z":o="z";for(f=[],i=[],v=[],y=e.type-1;y>=0;y--){b=l(o,y);f.push(b),i=i.concat(b),v=v.concat(u(b,"cw"))}i.to=v,p=-90;break;case"Z'":o="z";for(f=[],i=[],v=[],y=e.type-1;y>=0;y--){b=l(o,y);f.push(b),i=i.concat(b),v=v.concat(u(b,"ccw"))}i.to=v,p=90;break;default:return}$(i).each(function(){n.add(this)}),$({rotation:n.rotation[o]}).animate({rotation:n.rotation[o]+p*r},{easing:"swing",step:function(e){n.rotation[o]=e},duration:e.animation.delay,complete:function(){!function(e){t=e,$(t).each(function(){var e=this.material.materials;if(n.rotation.x>0){var t=e[2];e[2]=e[5],e[5]=e[3],e[3]=e[4],e[4]=t}else if(n.rotation.x<0){var t=e[4];e[4]=e[3],e[3]=e[5],e[5]=e[2],e[2]=t}else if(n.rotation.y<0){var t=e[4];e[4]=e[0],e[0]=e[5],e[5]=e[1],e[1]=t}else if(n.rotation.y>0){var t=e[4];e[4]=e[1],e[1]=e[5],e[5]=e[0],e[0]=t}else if(n.rotation.z<0){var t=e[2];e[2]=e[1],e[1]=e[3],e[3]=e[0],e[0]=t}else if(n.rotation.z>0){var t=e[2];e[2]=e[0],e[0]=e[3],e[3]=e[1],e[1]=t}this.material.needsUpdate=!0});var t;for(var a=0;a<e.length;a++)e[a];(function(e,t){for(var a=0;a<e.length;a++)e[a].material=t[a].material,e[a].material.needsUpdate=!0})(e,e.to),n.rotation.x=n.rotation.y=n.rotation.z=0}(i),t.trigger("next-move")}})},t.execute=function(e){e=function(e){for(var t=["U","u","R","r","D","d","L","l","F","f","B","b","M","E","S","X","Y","Z","2","'"],a=(e=(e=e.replace(/\(/gm,"").replace(/\)/gm,"").replace(/\[/gm,"").replace(/\]/gm,"").replace(/\n/gm," ")).replace(/Fw/gm,"f").replace(/Bw/gm,"b").replace(/Rw/gm,"r").replace(/Lw/gm,"l").replace(/Uw/gm,"u").replace(/Dw/gm,"d").replace(/x/gm,"X").replace(/y/gm,"Y").replace(/z/gm,"Z")).split(" "),c=[],o=0;o<a.length;o++){var r=a[o];if(!(0==r.length||r.length>3)){for(var n=!0,i=0;i<r.length;i++){var p=r[i];if($.inArray(p,t)<0){n=!1;break}}if(n){var y=r[1];if($.isNumeric(y))for(r=r.replace(r[1],"");y--;)c.push(r);else c.push(r)}}}return c}(e);var a=t.data("move-stack");a&&(e=a.concat(e)),console.info(e),t.data("move-stack",e),a||t.trigger("next-move")},t.on("next-move",function(a){var c=t.data("move-stack");if(c){var o=c.shift();o||(c=null),t.data("move-stack",c),o?t.turn(o):e.onComplete(t)}}),function(){c=new THREE.Scene,o=new THREE.PerspectiveCamera(75,t.width()/t.height(),.1,1e3);try{(a=new THREE.WebGLRenderer({antialias:!0})).type="WebGL"}catch(e){(a=new THREE.CanvasRenderer).type="Canvas"}a.setSize(t.width(),t.height()),a.setClearColor(e.background,1),t.append(a.domElement),y(),o.position.x=e.camera.x,o.position.y=e.camera.y,o.position.z=e.camera.z,t.data("_cube",t),s(),t.data("moves")&&setTimeout(function(){t.execute(t.data("moves"))},1e3)}(),t};
