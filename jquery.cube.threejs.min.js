/*
 * Copyright 2016 Jason Graves (GodLikeMouse/Collaboradev)
 * http://www.collaboradev.com
 *
 * This file is part of jquery.cube.threejs.js.
 *
 * The jquery.cube.threejs.js plugin is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation, either
 * version 3 of the License, or (at your option) any later version.
 *
 * The jquery.cube.threejs.js plugin is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with the jquery.cube.threejs.js plugin. If not, see http://www.gnu.org/licenses/.
 */

$.fn.cube=function(e){function t(e){var t=["U","u","R","r","D","d","L","l","F","f","B","b","M","E","S","X","Y","Z","2","'"];e=e.replace(/\(/gm,"").replace(/\)/gm,"").replace(/\[/gm,"").replace(/\]/gm,"").replace(/\n/gm," "),e=e.replace(/Fw/gm,"f").replace(/Bw/gm,"b").replace(/Rw/gm,"r").replace(/Lw/gm,"l").replace(/Uw/gm,"u").replace(/Dw/gm,"d").replace(/x/gm,"X").replace(/y/gm,"Y").replace(/z/gm,"Z");for(var a=e.split(" "),c=[],r=0;r<a.length;r++){var o=a[r];if(!(0==o.length||o.length>3)){for(var n=!0,p=0;p<o.length;p++){var i=o[p];if($.inArray(i,t)<0){n=!1;break}}if(n){var y=o[1];if($.isNumeric(y))for(o=o.replace(o[1],"");y--;)c.push(o);else c.push(o)}}}return c}function a(t){for(var c=[],r=0;6>r;r++){var o=e.color[r],n=new THREE.MeshBasicMaterial({color:o});n.map=h,c.push(n)}var p=new THREE.MeshFaceMaterial(c);a.box||(a.box=new THREE.BoxGeometry(e.cubit.width,e.cubit.height,e.cubit.height));var i=new THREE.Mesh(a.box,p);return i.position.x=t.x,i.position.y=t.y,i.position.z=t.z,l.add(i),f.push(i),i.index=f.length-1,i}function c(){e.cubit={width:e.size.width/e.type,height:e.size.height/e.type};var t=0;e.type%2==0&&(t=e.cubit.width/2);for(var c=e.type-Math.ceil(e.type/2),r=new THREE.Vector3(0,0,0),o=0;o<e.type;o++){for(var n=0;n<e.type;n++)for(var p=0;p<e.type;p++){r.x=e.cubit.width*(p-c)+t,r.y=e.cubit.height*(n-c)+t,r.z=e.cubit.height*(o-c)+t;var i=a(r);p>0&&p<e.type-1&&n>0&&n<e.type-1&&o>0&&o<e.type-1&&(i.visible=!1)}b=new THREE.Object3D,l.add(b)}}function r(){requestAnimationFrame(r),w.render(l,u),u.lookAt(b.position)}function o(t,a){var c=e.type*e.type;switch(t){case"y":for(var r=[],o=a*e.type,n=0;n<e.type;n++){for(var p=0;p<e.type;p++){var i=p;r.push(f[o+i])}o+=c}return r;case"x":for(var r=[],o=c+a,n=0;n<e.type;n++){for(var p=0;p<e.type;p++){var i=(p+1)*e.type;r.push(f[o-i])}o+=c}return r;case"z":for(var r=[],o=c+a*c-e.type,n=0;n<e.type;n++){for(var p=0;p<e.type;p++){var i=p;r.push(f[o+i])}o-=e.type}return r}}function n(t,a){if("cw"==a){for(var c=[],r=e.type*(e.type-1),o=0;o<e.type;o++){for(var n=0;n<e.type;n++){var p=n*e.type;c.push(t[r-p].clone())}r++}return c}for(var c=[],r=e.type-1,o=0;o<e.type;o++){for(var n=0;n<e.type;n++){var p=n*e.type;c.push(t[r+p].clone())}r--}return c}function p(e,t){for(var a=0;a<e.length;a++)e[a].material=t[a].material,e[a].material.needsUpdate=!0}function i(e){var t=0,a=1,c=2,r=3,o=4,n=5;$(e).each(function(){var e=this,p=e.material.materials;if(b.rotation.x>0){var i=p[c];p[c]=p[n],p[n]=p[r],p[r]=p[o],p[o]=i}else if(b.rotation.x<0){var i=p[o];p[o]=p[r],p[r]=p[n],p[n]=p[c],p[c]=i}else if(b.rotation.y<0){var i=p[o];p[o]=p[t],p[t]=p[n],p[n]=p[a],p[a]=i}else if(b.rotation.y>0){var i=p[o];p[o]=p[a],p[a]=p[n],p[n]=p[t],p[t]=i}else if(b.rotation.z<0){var i=p[c];p[c]=p[a],p[a]=p[r],p[r]=p[t],p[t]=i}else if(b.rotation.z>0){var i=p[c];p[c]=p[t],p[t]=p[r],p[r]=p[a],p[a]=i}e.material.needsUpdate=!0})}function y(e){i(e);for(var t=[],a=0;a<e.length;a++)t=e[a];p(e,e.to),b.rotation.x=b.rotation.y=b.rotation.z=0}function s(){var t=new Image;h=new THREE.Texture(t),h.anisotropy=4,t.onload=function(){h.needsUpdate=!0},t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4AIJFwERt5oJjgAAAHBJREFUWMPt17ERgDAMQ1GZwpmGzRMGYhg+BQkjOI1058KV3p0rhyRUGyTFWg5JyswbGIAKJoCemfcvAjrwUJcH6JKICdCORMR3gp0xwAADDDDAAAMMMMAAAwxYgFH8pDI7P0Br7ZR0FQLG7FTsfs9fuubdLARBVA4AAAAASUVORK5CYII=",l=new THREE.Scene,u=new THREE.PerspectiveCamera(75,v.width()/v.height(),.1,1e3),w=new THREE.WebGLRenderer({antialias:!0}),w.setSize(v.width(),v.height()),w.setClearColor(e.background,1),v.append(w.domElement),c(),u.position.y=e.camera.x,u.position.x=e.camera.y,u.position.z=e.camera.z,v.data("_cube",v),r(),v.data("moves")&&setTimeout(function(){v.execute(v.data("moves"))},1e3)}var v=this,w=null,l=null,u=null,f=[],h=null,b=null;return e=$.extend(!0,{type:3,camera:{x:50,y:50,z:100},size:{width:60,height:60},color:[16711680,16744448,16776960,16777215,255,65280],background:1908512,animation:{delay:250},onTurn:$.noop,onComplete:$.noop},e),v.turn=function(t){e.onTurn(v,t);for(var a=null,c=Math.PI/180,r=null,p=0,i=b.children.length-1;i>=0;i--)l.add(b.children[i]),b.remove(b.children[i]);switch(b.children=[],t){case"U":a="y",r=o(a,e.type-1),r.to=n(r,"cw"),p=-90;break;case"U'":a="y",r=o(a,e.type-1),r.to=n(r,"ccw"),p=90;break;case"u":a="y";var s=o(a,e.type-2),w=o(a,e.type-1);r=3==e.type?s.concat(w):s,r.to=n(s,"ccw"),e.type>3&&(r.to=r.to.concat(n(w,"ccw"))),p=-90;break;case"u'":a="y";var s=o(a,e.type-2),w=o(a,e.type-1);r=3==e.type?s.concat(w):s,r.to=n(s,"cw"),e.type>3&&(r.to=r.to.concat(n(w,"cw"))),p=90;break;case"R":a="x",r=o(a,e.type-1),r.to=n(r,"cw"),p=-90;break;case"R'":a="x",r=o(a,e.type-1),r.to=n(r,"ccw"),p=90;break;case"r":a="x";var s=o(a,e.type-2),w=o(a,e.type-1);r=3==e.type?s.concat(w):s,r.to=n(s,"cw"),3==e.type&&(r.to=r.to.concat(n(w,"cw"))),p=-90;break;case"r'":a="x";var s=o(a,e.type-2),w=o(a,e.type-1);r=3==e.type?s.concat(w):s,r.to=n(s,"ccw"),3==e.type&&(r.to=r.to.concat(n(w,"ccw"))),p=90;break;case"D":a="y",r=o(a,0),r.to=n(r,"ccw"),p=90;break;case"D'":a="y",r=o(a,0),r.to=n(r,"cw"),p=-90;break;case"d":a="y";var s=o("y",0),w=o("y",1);r=3==e.type?s.concat(w):s,r.to=n(s,"ccw"),3==e.type&&(r.to=r.to.concat(n(w,"ccw"))),p=90;break;case"d'":a="y";var s=o(a,0),w=o(a,1);r=3==e.type?s.concat(w):s,r.to=n(s,"cw"),3==e.type&&(r.to=r.to.concat(n(w,"cw"))),p=-90;break;case"L":a="x",r=o(a,0),r.to=n(r,"ccw"),p=90;break;case"L'":a="x",r=o(a,0),r.to=n(r,"cw"),p=-90;break;case"l":a="x";var s=o(a,1),w=o(a,0);r=3==e.type?s.concat(w):s,r.to=n(s,"cw"),3==e.type&&(r.to=r.to.concat(n(w,"cw"))),p=90;break;case"l'":a="x";var s=o(a,1),w=o(a,0);r=3==e.type?s.concat(w):s,r.to=n(s,"cw"),3==e.type&&(r.to=r.to.concat(n(w,"cw"))),p=-90;break;case"F":a="z",r=o(a,e.type-1),r.to=n(r,"cw"),p=-90;break;case"F'":a="z",r=o(a,e.type-1),r.to=n(r,"ccw"),p=90;break;case"f":a="z";var s=o(a,e.type-2),w=o(a,e.type-1);r=3==e.type?s.concat(w):s,r.to=n(s,"cw"),e.type>3&&(r.to=r.to.concat(n(w,"cw"))),p=-90;break;case"f'":a="z";var s=o(a,e.type-2),w=o(a,e.type-1);r=3==e.type?s.concat(w):s,r.to=n(s,"ccw"),e.type>3&&(r.to=r.to.concat(n(w,"ccw"))),p=90;break;case"B":a="z",r=o(a,0),r.to=n(r,"ccw"),p=90;break;case"B'":a="z",r=o(a,0),r.to=n(r,"cw"),p=-90;break;case"b":a="z";var s=o(a,0),w=o(a,1);r=3==e.type?s.concat(w):s,r.to=n(s,"ccw"),e.type>3&&(r.to=r.to.concat(n(w,"ccw"))),p=90;break;case"b'":a="z";var s=o(a,0),w=o(a,1);r=3==e.type?s.concat(w):s,r.to=n(s,"cw"),e.type>3&&(r.to=r.to.concat(n(w,"cw"))),p=-90;break;case"M":if(e.type%2!=0){a="x";var u=parseInt(e.type/2);r=o(a,u),r.to=n(r,"cw"),p=90}break;case"M'":if(e.type%2!=0){a="x";var u=parseInt(e.type/2);r=o(a,u),r.to=n(r,"ccw"),p=-90}break;case"E":if(e.type%2!=0){a="y";var u=parseInt(e.type/2);r=o(a,u),r.to=n(r,"cw"),p=-90}break;case"E'":if(e.type%2!=0){a="y";var u=parseInt(e.type/2);r=o(a,u),r.to=n(r,"ccw"),p=90}break;case"S":if(e.type%2!=0){a="z";var u=parseInt(e.type/2);r=o(a,u),r.to=n(r,"cw"),p=-90}break;case"S'":if(e.type%2!=0){a="z";var u=parseInt(e.type/2);r=o(a,u),r.to=n(r,"ccw"),p=90}break;case"X":a="x";for(var f=[],r=[],h=[],i=e.type-1;i>=0;i--){var A=o(a,i);f.push(A),r=r.concat(A),h=h.concat(n(A,"cw"))}r.to=h,p=-90;break;case"X'":a="x";for(var f=[],r=[],h=[],i=e.type-1;i>=0;i--){var A=o(a,i);f.push(A),r=r.concat(A),h=h.concat(n(A,"ccw"))}r.to=h,p=90;break;case"Y":a="y";for(var f=[],r=[],h=[],i=e.type-1;i>=0;i--){var A=o(a,i);f.push(A),r=r.concat(A),h=h.concat(n(A,"cw"))}r.to=h,p=-90;break;case"Y'":a="y";for(var f=[],r=[],h=[],i=e.type-1;i>=0;i--){var A=o(a,i);f.push(A),r=r.concat(A),h=h.concat(n(A,"ccw"))}r.to=h,p=90;break;case"Z":a="z";for(var f=[],r=[],h=[],i=e.type-1;i>=0;i--){var A=o(a,i);f.push(A),r=r.concat(A),h=h.concat(n(A,"cw"))}r.to=h,p=-90;break;case"Z'":a="z";for(var f=[],r=[],h=[],i=e.type-1;i>=0;i--){var A=o(a,i);f.push(A),r=r.concat(A),h=h.concat(n(A,"ccw"))}r.to=h,p=90;break;default:return}$(r).each(function(){b.add(this)}),$({rotation:b.rotation[a]}).animate({rotation:b.rotation[a]+p*c},{easing:"swing",step:function(e){b.rotation[a]=e},duration:e.animation.delay,complete:function(){y(r),v.trigger("next-move")}})},v.execute=function(e){e=t(e);var a=v.data("move-stack");a&&(e=a.concat(e)),console.info(e),v.data("move-stack",e),a||v.trigger("next-move")},v.on("next-move",function(t){var a=v.data("move-stack");if(a){var c=a.shift();c||(a=null),v.data("move-stack",a),c?v.turn(c):e.onComplete(v)}}),s(),v};
