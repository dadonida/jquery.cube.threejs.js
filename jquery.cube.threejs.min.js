/*
 * Copyright 2016 Jason Graves (GodLikeMouse/Collaboradev)
 * http://www.collaboradev.com
 *
 * This file is part of jquery.cube.threejs.js.
 *
 * The jquery.cube.threejs.js plugin is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation, either
 * version 3 of the License, or (at your option) any later version.
 *
 * The jquery.cube.threejs.js plugin is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with the jquery.cube.threejs.js plugin. If not, see http://www.gnu.org/licenses/.
 */

$.fn.cube=function(e){function t(e){for(var t=["U","u","R","r","D","d","L","l","F","f","B","b","M","E","S","X","Y","Z","2","'"],a=(e=(e=e.replace(/\(/gm,"").replace(/\)/gm,"").replace(/\[/gm,"").replace(/\]/gm,"").replace(/\n/gm," ")).replace(/Fw/gm,"f").replace(/Bw/gm,"b").replace(/Rw/gm,"r").replace(/Lw/gm,"l").replace(/Uw/gm,"u").replace(/Dw/gm,"d").replace(/x/gm,"X").replace(/y/gm,"Y").replace(/z/gm,"Z")).split(" "),c=[],o=0;o<a.length;o++){var r=a[o];if(!(0==r.length||r.length>3)){for(var n=!0,i=0;i<r.length;i++){var p=r[i];if($.inArray(p,t)<0){n=!1;break}}if(n){var y=r[1];if($.isNumeric(y))for(r=r.replace(r[1],"");y--;)c.push(r);else c.push(r)}}}return c}function a(t,c,o){function r(e){var t=new THREE.Color(e),a=Number(255*t.r).toString(16),c=Number(255*t.g).toString(16),o=Number(255*t.b).toString(16);return a=a.toString().length<2?"0"+a:a,c=c.toString().length<2?"0"+c:c,o=o.toString().length<2?"0"+o:o,"#"+a+c+o}if(a[o])return a[o];var n=$("<canvas>").get(0);n.width=t,n.height=c;var i=n.getContext("2d");i.fillStyle=r(e.color[e.color.length-1]),i.fillRect(0,0,t,c),i.fillStyle=r(o),function(e,t,a,c,o){i.beginPath(),i.moveTo(e+o,t),i.lineTo(e+a-o,t),i.quadraticCurveTo(e+a,t,e+a,t+o),i.lineTo(e+a,t+c-o),i.quadraticCurveTo(e+a,t+c,e+a-o,t+c),i.lineTo(e+o,t+c),i.quadraticCurveTo(e,t+c,e,t+c-o),i.lineTo(e,t+o),i.quadraticCurveTo(e,t,e+o,t),i.closePath(),i.fill()}(1,1,t-2,c-2,3);var p=new Image;p.src=n.toDataURL();var y=new THREE.Texture(p);return y.anisotropy=4,y.needsUpdate=!0,a[o]=y,y}function c(t){for(var o=[],r=0;r<6;r++){var n=a(32,32,e.color[r]),i=new THREE.MeshBasicMaterial({map:n,overdraw:1});o.push(i)}var p=new THREE.MeshFaceMaterial(o),y="Canvas"==u.type?3:1;c.box||(c.box=new THREE.BoxGeometry(e.cubit.width,e.cubit.height,e.cubit.height,y,y,y));var s=new THREE.Mesh(c.box,p);return s.position.x=t.x,s.position.y=t.y,s.position.z=t.z,v.add(s),w.push(s),s.index=w.length-1,s}function o(){e.cubit={width:e.size.width/e.type,height:e.size.height/e.type};var t=0;e.type%2==0&&(t=e.cubit.width/2);for(var a=e.type-Math.ceil(e.type/2),o=new THREE.Vector3(0,0,0),r=0;r<e.type;r++){for(var n=0;n<e.type;n++)for(var i=0;i<e.type;i++){o.x=e.cubit.width*(i-a)+t,o.y=e.cubit.height*(n-a)+t,o.z=e.cubit.height*(r-a)+t;var p=c(o);i>0&&i<e.type-1&&n>0&&n<e.type-1&&r>0&&r<e.type-1&&(p.visible=!1)}h=new THREE.Object3D,v.add(h)}}function r(){requestAnimationFrame(r),u.render(v,f),f.lookAt(h.position)}function n(t,a){var c=e.type*e.type;switch(t){case"y":for(var o=[],r=a*e.type,n=0;n<e.type;n++){for(i=0;i<e.type;i++){p=i;o.push(w[r+p])}r+=c}return o;case"x":for(var o=[],r=c+a,n=0;n<e.type;n++){for(i=0;i<e.type;i++){p=(i+1)*e.type;o.push(w[r-p])}r+=c}return o;case"z":for(var o=[],r=c+a*c-e.type,n=0;n<e.type;n++){for(var i=0;i<e.type;i++){var p=i;o.push(w[r+p])}r-=e.type}return o}}function i(t,a){if("cw"==a){for(var c=[],o=e.type*(e.type-1),r=0;r<e.type;r++){for(n=0;n<e.type;n++){i=n*e.type;c.push(t[o-i].clone())}o++}return c}for(var c=[],o=e.type-1,r=0;r<e.type;r++){for(var n=0;n<e.type;n++){var i=n*e.type;c.push(t[o+i].clone())}o--}return c}function p(e,t){for(var a=0;a<e.length;a++)e[a].material=t[a].material,e[a].material.needsUpdate=!0}function y(e){$(e).each(function(){var e=this,t=e.material.materials;if(h.rotation.x>0){a=t[2];t[2]=t[5],t[5]=t[3],t[3]=t[4],t[4]=a}else if(h.rotation.x<0){a=t[4];t[4]=t[3],t[3]=t[5],t[5]=t[2],t[2]=a}else if(h.rotation.y<0){a=t[4];t[4]=t[0],t[0]=t[5],t[5]=t[1],t[1]=a}else if(h.rotation.y>0){a=t[4];t[4]=t[1],t[1]=t[5],t[5]=t[0],t[0]=a}else if(h.rotation.z<0){a=t[2];t[2]=t[1],t[1]=t[3],t[3]=t[0],t[0]=a}else if(h.rotation.z>0){var a=t[2];t[2]=t[0],t[0]=t[3],t[3]=t[1],t[1]=a}e.material.needsUpdate=!0})}function s(e){y(e);for(var t=0;t<e.length;t++)e[t];p(e,e.to),h.rotation.x=h.rotation.y=h.rotation.z=0}var l=this,u=null,v=null,f=null,w=[],h=null;return e=$.extend(!0,{type:3,camera:{x:50,y:50,z:100},size:{width:60,height:60},color:[16711680,16744448,16776960,16777215,255,65280,0],background:1908512,animation:{delay:250},onTurn:$.noop,onComplete:$.noop},e),l.reset=function(){for(var e=v.children.length-1;e>=0;e--)v.remove(v.children[e]);w=[],o()},l.turn=function(t){e.onTurn(l,t);for(var a=null,c=Math.PI/180,o=null,r=0,p=h.children.length-1;p>=0;p--)v.add(h.children[p]),h.remove(h.children[p]);switch(h.children=[],t){case"U":(o=n(a="y",e.type-1)).to=i(o,"cw"),r=-90;break;case"U'":(o=n(a="y",e.type-1)).to=i(o,"ccw"),r=90;break;case"u":var y=n(a="y",e.type-2),u=n(a,e.type-1);(o=3==e.type?y.concat(u):y).to=i(y,"ccw"),e.type>=3&&(o.to=o.to.concat(i(u,"ccw"))),r=-90;break;case"u'":var y=n(a="y",e.type-2),u=n(a,e.type-1);(o=3==e.type?y.concat(u):y).to=i(y,"cw"),e.type>=3&&(o.to=o.to.concat(i(u,"cw"))),r=90;break;case"R":(o=n(a="x",e.type-1)).to=i(o,"cw"),r=-90;break;case"R'":(o=n(a="x",e.type-1)).to=i(o,"ccw"),r=90;break;case"r":var y=n(a="x",e.type-2),u=n(a,e.type-1);(o=3==e.type?y.concat(u):y).to=i(y,"cw"),3==e.type&&(o.to=o.to.concat(i(u,"cw"))),r=-90;break;case"r'":var y=n(a="x",e.type-2),u=n(a,e.type-1);(o=3==e.type?y.concat(u):y).to=i(y,"ccw"),3==e.type&&(o.to=o.to.concat(i(u,"ccw"))),r=90;break;case"D":(o=n(a="y",0)).to=i(o,"ccw"),r=90;break;case"D'":(o=n(a="y",0)).to=i(o,"cw"),r=-90;break;case"d":a="y";var y=n("y",0),u=n("y",1);(o=3==e.type?y.concat(u):y).to=i(y,"ccw"),3==e.type&&(o.to=o.to.concat(i(u,"ccw"))),r=90;break;case"d'":var y=n(a="y",0),u=n(a,1);(o=3==e.type?y.concat(u):y).to=i(y,"cw"),3==e.type&&(o.to=o.to.concat(i(u,"cw"))),r=-90;break;case"L":(o=n(a="x",0)).to=i(o,"ccw"),r=90;break;case"L'":(o=n(a="x",0)).to=i(o,"cw"),r=-90;break;case"l":var y=n(a="x",1),u=n(a,0);(o=3==e.type?y.concat(u):y).to=i(y,"cw"),3==e.type&&(o.to=o.to.concat(i(u,"cw"))),r=90;break;case"l'":var y=n(a="x",1),u=n(a,0);(o=3==e.type?y.concat(u):y).to=i(y,"cw"),3==e.type&&(o.to=o.to.concat(i(u,"cw"))),r=-90;break;case"F":(o=n(a="z",e.type-1)).to=i(o,"cw"),r=-90;break;case"F'":(o=n(a="z",e.type-1)).to=i(o,"ccw"),r=90;break;case"f":var y=n(a="z",e.type-2),u=n(a,e.type-1);(o=3==e.type?y.concat(u):y).to=i(y,"cw"),e.type>=3&&(o.to=o.to.concat(i(u,"cw"))),r=-90;break;case"f'":var y=n(a="z",e.type-2),u=n(a,e.type-1);(o=3==e.type?y.concat(u):y).to=i(y,"ccw"),e.type>=3&&(o.to=o.to.concat(i(u,"ccw"))),r=90;break;case"B":(o=n(a="z",0)).to=i(o,"ccw"),r=90;break;case"B'":(o=n(a="z",0)).to=i(o,"cw"),r=-90;break;case"b":var y=n(a="z",0),u=n(a,1);(o=3==e.type?y.concat(u):y).to=i(y,"ccw"),e.type>=3&&(o.to=o.to.concat(i(u,"ccw"))),r=90;break;case"b'":var y=n(a="z",0),u=n(a,1);(o=3==e.type?y.concat(u):y).to=i(y,"cw"),e.type>=3&&(o.to=o.to.concat(i(u,"cw"))),r=-90;break;case"M":if(e.type%2!=0){a="x";f=parseInt(e.type/2);(o=n(a,f)).to=i(o,"cw"),r=90}break;case"M'":if(e.type%2!=0){a="x";f=parseInt(e.type/2);(o=n(a,f)).to=i(o,"ccw"),r=-90}break;case"E":if(e.type%2!=0){a="y";f=parseInt(e.type/2);(o=n(a,f)).to=i(o,"cw"),r=-90}break;case"E'":if(e.type%2!=0){a="y";f=parseInt(e.type/2);(o=n(a,f)).to=i(o,"ccw"),r=90}break;case"S":if(e.type%2!=0){a="z";f=parseInt(e.type/2);(o=n(a,f)).to=i(o,"cw"),r=-90}break;case"S'":if(e.type%2!=0){a="z";var f=parseInt(e.type/2);(o=n(a,f)).to=i(o,"ccw"),r=90}break;case"X":a="x";for(var w=[],o=[],b=[],p=e.type-1;p>=0;p--){d=n(a,p);w.push(d),o=o.concat(d),b=b.concat(i(d,"cw"))}o.to=b,r=-90;break;case"X'":a="x";for(var w=[],o=[],b=[],p=e.type-1;p>=0;p--){d=n(a,p);w.push(d),o=o.concat(d),b=b.concat(i(d,"ccw"))}o.to=b,r=90;break;case"Y":a="y";for(var w=[],o=[],b=[],p=e.type-1;p>=0;p--){d=n(a,p);w.push(d),o=o.concat(d),b=b.concat(i(d,"cw"))}o.to=b,r=-90;break;case"Y'":a="y";for(var w=[],o=[],b=[],p=e.type-1;p>=0;p--){d=n(a,p);w.push(d),o=o.concat(d),b=b.concat(i(d,"ccw"))}o.to=b,r=90;break;case"Z":a="z";for(var w=[],o=[],b=[],p=e.type-1;p>=0;p--){d=n(a,p);w.push(d),o=o.concat(d),b=b.concat(i(d,"cw"))}o.to=b,r=-90;break;case"Z'":a="z";for(var w=[],o=[],b=[],p=e.type-1;p>=0;p--){var d=n(a,p);w.push(d),o=o.concat(d),b=b.concat(i(d,"ccw"))}o.to=b,r=90;break;default:return}$(o).each(function(){h.add(this)}),$({rotation:h.rotation[a]}).animate({rotation:h.rotation[a]+r*c},{easing:"swing",step:function(e){h.rotation[a]=e},duration:e.animation.delay,complete:function(){s(o),l.trigger("next-move")}})},l.execute=function(e){e=t(e);var a=l.data("move-stack");a&&(e=a.concat(e)),console.info(e),l.data("move-stack",e),a||l.trigger("next-move")},l.on("next-move",function(t){var a=l.data("move-stack");if(a){var c=a.shift();c||(a=null),l.data("move-stack",a),c?l.turn(c):e.onComplete(l)}}),function(){v=new THREE.Scene,f=new THREE.PerspectiveCamera(75,l.width()/l.height(),.1,1e3);try{(u=new THREE.WebGLRenderer({antialias:!0})).type="WebGL"}catch(e){(u=new THREE.CanvasRenderer).type="Canvas"}u.setSize(l.width(),l.height()),u.setClearColor(e.background,1),l.append(u.domElement),o(),f.position.y=e.camera.x,f.position.x=e.camera.y,f.position.z=e.camera.z,l.data("_cube",l),r(),l.data("moves")&&setTimeout(function(){l.execute(l.data("moves"))},1e3)}(),l};
