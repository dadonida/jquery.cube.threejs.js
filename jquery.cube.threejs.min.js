/*
 * Copyright 2016 Jason Graves (GodLikeMouse/Collaboradev)
 * http://www.collaboradev.com
 *
 * This file is part of jquery.cube.threejs.js.
 *
 * The jquery.cube.threejs.js plugin is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation, either
 * version 3 of the License, or (at your option) any later version.
 *
 * The jquery.cube.threejs.js plugin is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with the jquery.cube.threejs.js plugin. If not, see http://www.gnu.org/licenses/.
 */

$.fn.cube=function(e){function t(e){var t=["U","u","R","r","D","d","L","l","F","f","B","b","M","E","S","X","Y","Z","2","'"];e=e.replace(/\(/gm,"").replace(/\)/gm,"").replace(/\[/gm,"").replace(/\]/gm,"").replace(/\n/gm," "),e=e.replace(/Fw/gm,"f").replace(/Bw/gm,"b").replace(/Rw/gm,"r").replace(/Lw/gm,"l").replace(/Uw/gm,"u").replace(/Dw/gm,"d").replace(/x/gm,"X").replace(/y/gm,"Y").replace(/z/gm,"Z");for(var a=e.split(" "),r=[],c=0;c<a.length;c++){var o=a[c];if(!(0==o.length||o.length>3)){for(var n=!0,i=0;i<o.length;i++){var p=o[i];if($.inArray(p,t)<0){n=!1;break}}if(n){var y=o[1];if($.isNumeric(y))for(o=o.replace(o[1],"");y--;)r.push(o);else r.push(o)}}}return r}function a(t,r,c){function o(e,t,a,r,c){p.beginPath(),p.moveTo(e+c,t),p.lineTo(e+a-c,t),p.quadraticCurveTo(e+a,t,e+a,t+c),p.lineTo(e+a,t+r-c),p.quadraticCurveTo(e+a,t+r,e+a-c,t+r),p.lineTo(e+c,t+r),p.quadraticCurveTo(e,t+r,e,t+r-c),p.lineTo(e,t+c),p.quadraticCurveTo(e,t,e+c,t),p.closePath(),p.fill()}function n(e){var t=new THREE.Color(e),a=Number(255*t.r).toString(16),r=Number(255*t.g).toString(16),c=Number(255*t.b).toString(16);return a=a.toString().length<2?"0"+a:a,r=r.toString().length<2?"0"+r:r,c=c.toString().length<2?"0"+c:c,"#"+a+r+c}if(a[c])return a[c];var i=$("<canvas>").get(0);i.width=t,i.height=r;var p=i.getContext("2d");p.fillStyle=n(e.color[e.color.length-1]),p.fillRect(0,0,t,r),p.fillStyle=n(c),o(1,1,t-2,r-2,3);var y=new Image;y.src=i.toDataURL();var s=new THREE.Texture(y);return s.anisotropy=4,s.needsUpdate=!0,a[c]=s,s}function r(t){for(var c=[],o=0;6>o;o++){var n=e.color[o],i=a(32,32,n),p=new THREE.MeshBasicMaterial({map:i,overdraw:1});c.push(p)}var y=new THREE.MeshFaceMaterial(c),s="Canvas"==u.type?3:1;r.box||(r.box=new THREE.BoxGeometry(e.cubit.width,e.cubit.height,e.cubit.height,s,s,s));var v=new THREE.Mesh(r.box,y);return v.position.x=t.x,v.position.y=t.y,v.position.z=t.z,w.add(v),h.push(v),v.index=h.length-1,v}function c(){e.cubit={width:e.size.width/e.type,height:e.size.height/e.type};var t=0;e.type%2==0&&(t=e.cubit.width/2);for(var a=e.type-Math.ceil(e.type/2),c=new THREE.Vector3(0,0,0),o=0;o<e.type;o++){for(var n=0;n<e.type;n++)for(var i=0;i<e.type;i++){c.x=e.cubit.width*(i-a)+t,c.y=e.cubit.height*(n-a)+t,c.z=e.cubit.height*(o-a)+t;var p=r(c);i>0&&i<e.type-1&&n>0&&n<e.type-1&&o>0&&o<e.type-1&&(p.visible=!1)}b=new THREE.Object3D,w.add(b)}}function o(){requestAnimationFrame(o),u.render(w,f),f.lookAt(b.position)}function n(t,a){var r=e.type*e.type;switch(t){case"y":for(var c=[],o=a*e.type,n=0;n<e.type;n++){for(var i=0;i<e.type;i++){var p=i;c.push(h[o+p])}o+=r}return c;case"x":for(var c=[],o=r+a,n=0;n<e.type;n++){for(var i=0;i<e.type;i++){var p=(i+1)*e.type;c.push(h[o-p])}o+=r}return c;case"z":for(var c=[],o=r+a*r-e.type,n=0;n<e.type;n++){for(var i=0;i<e.type;i++){var p=i;c.push(h[o+p])}o-=e.type}return c}}function i(t,a){if("cw"==a){for(var r=[],c=e.type*(e.type-1),o=0;o<e.type;o++){for(var n=0;n<e.type;n++){var i=n*e.type;r.push(t[c-i].clone())}c++}return r}for(var r=[],c=e.type-1,o=0;o<e.type;o++){for(var n=0;n<e.type;n++){var i=n*e.type;r.push(t[c+i].clone())}c--}return r}function p(e,t){for(var a=0;a<e.length;a++)e[a].material=t[a].material,e[a].material.needsUpdate=!0}function y(e){var t=0,a=1,r=2,c=3,o=4,n=5;$(e).each(function(){var e=this,i=e.material.materials;if(b.rotation.x>0){var p=i[r];i[r]=i[n],i[n]=i[c],i[c]=i[o],i[o]=p}else if(b.rotation.x<0){var p=i[o];i[o]=i[c],i[c]=i[n],i[n]=i[r],i[r]=p}else if(b.rotation.y<0){var p=i[o];i[o]=i[t],i[t]=i[n],i[n]=i[a],i[a]=p}else if(b.rotation.y>0){var p=i[o];i[o]=i[a],i[a]=i[n],i[n]=i[t],i[t]=p}else if(b.rotation.z<0){var p=i[r];i[r]=i[a],i[a]=i[c],i[c]=i[t],i[t]=p}else if(b.rotation.z>0){var p=i[r];i[r]=i[t],i[t]=i[c],i[c]=i[a],i[a]=p}e.material.needsUpdate=!0})}function s(e){y(e);for(var t=[],a=0;a<e.length;a++)t=e[a];p(e,e.to),b.rotation.x=b.rotation.y=b.rotation.z=0}function v(){w=new THREE.Scene,f=new THREE.PerspectiveCamera(75,l.width()/l.height(),.1,1e3);try{u=new THREE.WebGLRenderer({antialias:!0}),u.type="WebGL"}catch(t){u=new THREE.CanvasRenderer,u.type="Canvas"}u.setSize(l.width(),l.height()),u.setClearColor(e.background,1),l.append(u.domElement),c(),f.position.y=e.camera.x,f.position.x=e.camera.y,f.position.z=e.camera.z,l.data("_cube",l),o(),l.data("moves")&&setTimeout(function(){l.execute(l.data("moves"))},1e3)}var l=this,u=null,w=null,f=null,h=[],b=null;return e=$.extend(!0,{type:3,camera:{x:50,y:50,z:100},size:{width:60,height:60},color:[16711680,16744448,16776960,16777215,255,65280,0],background:1908512,animation:{delay:250},onTurn:$.noop,onComplete:$.noop},e),l.turn=function(t){e.onTurn(l,t);for(var a=null,r=Math.PI/180,c=null,o=0,p=b.children.length-1;p>=0;p--)w.add(b.children[p]),b.remove(b.children[p]);switch(b.children=[],t){case"U":a="y",c=n(a,e.type-1),c.to=i(c,"cw"),o=-90;break;case"U'":a="y",c=n(a,e.type-1),c.to=i(c,"ccw"),o=90;break;case"u":a="y";var y=n(a,e.type-2),v=n(a,e.type-1);c=3==e.type?y.concat(v):y,c.to=i(y,"ccw"),e.type>3&&(c.to=c.to.concat(i(v,"ccw"))),o=-90;break;case"u'":a="y";var y=n(a,e.type-2),v=n(a,e.type-1);c=3==e.type?y.concat(v):y,c.to=i(y,"cw"),e.type>3&&(c.to=c.to.concat(i(v,"cw"))),o=90;break;case"R":a="x",c=n(a,e.type-1),c.to=i(c,"cw"),o=-90;break;case"R'":a="x",c=n(a,e.type-1),c.to=i(c,"ccw"),o=90;break;case"r":a="x";var y=n(a,e.type-2),v=n(a,e.type-1);c=3==e.type?y.concat(v):y,c.to=i(y,"cw"),3==e.type&&(c.to=c.to.concat(i(v,"cw"))),o=-90;break;case"r'":a="x";var y=n(a,e.type-2),v=n(a,e.type-1);c=3==e.type?y.concat(v):y,c.to=i(y,"ccw"),3==e.type&&(c.to=c.to.concat(i(v,"ccw"))),o=90;break;case"D":a="y",c=n(a,0),c.to=i(c,"ccw"),o=90;break;case"D'":a="y",c=n(a,0),c.to=i(c,"cw"),o=-90;break;case"d":a="y";var y=n("y",0),v=n("y",1);c=3==e.type?y.concat(v):y,c.to=i(y,"ccw"),3==e.type&&(c.to=c.to.concat(i(v,"ccw"))),o=90;break;case"d'":a="y";var y=n(a,0),v=n(a,1);c=3==e.type?y.concat(v):y,c.to=i(y,"cw"),3==e.type&&(c.to=c.to.concat(i(v,"cw"))),o=-90;break;case"L":a="x",c=n(a,0),c.to=i(c,"ccw"),o=90;break;case"L'":a="x",c=n(a,0),c.to=i(c,"cw"),o=-90;break;case"l":a="x";var y=n(a,1),v=n(a,0);c=3==e.type?y.concat(v):y,c.to=i(y,"cw"),3==e.type&&(c.to=c.to.concat(i(v,"cw"))),o=90;break;case"l'":a="x";var y=n(a,1),v=n(a,0);c=3==e.type?y.concat(v):y,c.to=i(y,"cw"),3==e.type&&(c.to=c.to.concat(i(v,"cw"))),o=-90;break;case"F":a="z",c=n(a,e.type-1),c.to=i(c,"cw"),o=-90;break;case"F'":a="z",c=n(a,e.type-1),c.to=i(c,"ccw"),o=90;break;case"f":a="z";var y=n(a,e.type-2),v=n(a,e.type-1);c=3==e.type?y.concat(v):y,c.to=i(y,"cw"),e.type>3&&(c.to=c.to.concat(i(v,"cw"))),o=-90;break;case"f'":a="z";var y=n(a,e.type-2),v=n(a,e.type-1);c=3==e.type?y.concat(v):y,c.to=i(y,"ccw"),e.type>3&&(c.to=c.to.concat(i(v,"ccw"))),o=90;break;case"B":a="z",c=n(a,0),c.to=i(c,"ccw"),o=90;break;case"B'":a="z",c=n(a,0),c.to=i(c,"cw"),o=-90;break;case"b":a="z";var y=n(a,0),v=n(a,1);c=3==e.type?y.concat(v):y,c.to=i(y,"ccw"),e.type>3&&(c.to=c.to.concat(i(v,"ccw"))),o=90;break;case"b'":a="z";var y=n(a,0),v=n(a,1);c=3==e.type?y.concat(v):y,c.to=i(y,"cw"),e.type>3&&(c.to=c.to.concat(i(v,"cw"))),o=-90;break;case"M":if(e.type%2!=0){a="x";var u=parseInt(e.type/2);c=n(a,u),c.to=i(c,"cw"),o=90}break;case"M'":if(e.type%2!=0){a="x";var u=parseInt(e.type/2);c=n(a,u),c.to=i(c,"ccw"),o=-90}break;case"E":if(e.type%2!=0){a="y";var u=parseInt(e.type/2);c=n(a,u),c.to=i(c,"cw"),o=-90}break;case"E'":if(e.type%2!=0){a="y";var u=parseInt(e.type/2);c=n(a,u),c.to=i(c,"ccw"),o=90}break;case"S":if(e.type%2!=0){a="z";var u=parseInt(e.type/2);c=n(a,u),c.to=i(c,"cw"),o=-90}break;case"S'":if(e.type%2!=0){a="z";var u=parseInt(e.type/2);c=n(a,u),c.to=i(c,"ccw"),o=90}break;case"X":a="x";for(var f=[],c=[],h=[],p=e.type-1;p>=0;p--){var d=n(a,p);f.push(d),c=c.concat(d),h=h.concat(i(d,"cw"))}c.to=h,o=-90;break;case"X'":a="x";for(var f=[],c=[],h=[],p=e.type-1;p>=0;p--){var d=n(a,p);f.push(d),c=c.concat(d),h=h.concat(i(d,"ccw"))}c.to=h,o=90;break;case"Y":a="y";for(var f=[],c=[],h=[],p=e.type-1;p>=0;p--){var d=n(a,p);f.push(d),c=c.concat(d),h=h.concat(i(d,"cw"))}c.to=h,o=-90;break;case"Y'":a="y";for(var f=[],c=[],h=[],p=e.type-1;p>=0;p--){var d=n(a,p);f.push(d),c=c.concat(d),h=h.concat(i(d,"ccw"))}c.to=h,o=90;break;case"Z":a="z";for(var f=[],c=[],h=[],p=e.type-1;p>=0;p--){var d=n(a,p);f.push(d),c=c.concat(d),h=h.concat(i(d,"cw"))}c.to=h,o=-90;break;case"Z'":a="z";for(var f=[],c=[],h=[],p=e.type-1;p>=0;p--){var d=n(a,p);f.push(d),c=c.concat(d),h=h.concat(i(d,"ccw"))}c.to=h,o=90;break;default:return}$(c).each(function(){b.add(this)}),$({rotation:b.rotation[a]}).animate({rotation:b.rotation[a]+o*r},{easing:"swing",step:function(e){b.rotation[a]=e},duration:e.animation.delay,complete:function(){s(c),l.trigger("next-move")}})},l.execute=function(e){e=t(e);var a=l.data("move-stack");a&&(e=a.concat(e)),console.info(e),l.data("move-stack",e),a||l.trigger("next-move")},l.on("next-move",function(t){var a=l.data("move-stack");if(a){var r=a.shift();r||(a=null),l.data("move-stack",a),r?l.turn(r):e.onComplete(l)}}),v(),l};
